<div id="inventory">
<div class="inventory-page">
  <h1>Inventory</h1>

  <button type="button" class="add-button btn btn-primary" id="openModalBtn">
    <%= fa_icon "plus-circle", class: "text-muted pull-left" %> Add Inventory
  </button>

  <!-- INVENTORY TABLE WITH FILTER FORM -->
  <%= search_form_for @q, url: inventories_path, method: :get do |f| %>
    <div class="inventory-table-container mt-4">
      <table id="inventoryTable">
        <thead>
                <th></th>
                <th class="text-center">
                  <%= sort_link(@q, :name, 'Name') %>
                </th>
                <th>
                  <%= sort_link(@q, :category_id, 'Category') %>
                </th>
                <th>
                  <%= sort_link(@q, :unit_id, 'Unit') %>
                </th>
                <th class="text-center">
                  <%= sort_link(@q, :quantity, 'Quantity') %>
                </th>
                <th class="text-center">
                  <%= sort_link(@q, :input_date, 'Input Date') %>
                </th>
                <th class="text-center">
                  <%= sort_link(@q, :price, 'Price') %>
                </th>

          <!-- FILTER ROW -->
          <tr>
          <th>
              <div class="filter-buttons">
                <%= button_tag "Search", type: "submit", class: "btn filter-btn" %>
                <%= link_to "Reset", inventories_path, class: "btn reset-btn" %>
              </div>
            </th>
            <th><%= f.text_field :name_cont, class: "form-control form-control-sm", placeholder: "Search Name" %></th>
          <th>
                <%= f.select :category_id_eq,
                            options_from_collection_for_select(@categories, :id, :name),
                            { include_blank: "Select Category" },
                            class: "form-control form-control-sm" %>
              </th>

              <th>
                <%= f.select :unit_id_eq,
                            options_from_collection_for_select(@units, :id, :name),
                            { include_blank: "Select Unit" },
                            class: "form-control form-control-sm" %>
              </th>
            <th></th>
              <th class="text-center">
                  <div class="input-group input-group-sm">
                    <input type="text"
                           class="form-control form-control-sm cursor-pointer"
                           placeholder="Select Date Range"
                           data-controller="flatpickr"
                           data-flatpickr-mode-value="range"
                           data-flatpickr-date-format-value="d-m-Y"
                           data-flatpickr-field-name-value="q[input_date]">
                    <span class="input-group-text cursor-pointer" data-action="click->flatpickr#open">
                      <i class="bi bi-calendar-range"></i>
                    </span>
                  </div>
                  <%= f.hidden_field :input_date_gteq, value: params.dig(:q, :input_date_gteq) %>
                  <%= f.hidden_field :input_date_lteq, value: params.dig(:q, :input_date_lteq) %>
              </th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <% if @inventories.any? %>
            <% @inventories.each do |inventory| %>
              <tr data-supplier="<%= inventory.supplier %>">
                <td class="text-center">
                  <a href="#" title="Info" class="mx-1" data-turbo="false"><i class="bi bi-info-circle-fill info-icon text-primary" data-id="<%= inventory.id %>"></i></a>
                  <a href="#" title="Edit" class="mx-1" data-turbo="false"><i class="bi bi-pencil-fill edit-icon text-warning" data-id="<%= inventory.id %>"></i></a>
                  <a href="#" title="Delete" class="mx-1" data-turbo="false"><i class="bi bi-trash-fill delete-icon text-danger" data-id="<%= inventory.id %>"></i></a>
                </td>
                <td><%= inventory.name %></td>
                <td data-id="<%= inventory.category_id %>"><%= inventory.category&.name %></td>
                <td data-id="<%= inventory.unit_id %>"><%= inventory.unit&.name %></td>
                <td><%= inventory.stock_quantity %></td>
                <td><%= inventory.input_date.strftime("%d-%m-%Y") if inventory.input_date %></td>
                <td>RM <%= number_with_precision(inventory.price, precision: 2, delimiter: ',') %></td>
              </tr>
            <% end %>
          <% else %>
            <tr id="noDataRow" style="text-align: center; color: #6c757d;">
              <td colspan="8">
                <i class="fa fa-exclamation-circle"></i> There is no data!
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <!-- PAGINATION -->
  <div class="pagination-container d-flex justify-content-between align-items-center mt-3">
    <div class="d-flex align-items-center gap-2">
      <span class="text-muted small">Show</span>
      <%= per_page_selector(current: params[:per_page] || 10) %>
      <span class="text-muted small">
      <%== @pagy.info_tag(item_name: 'Inventories') %>
      </span>
    </div>
    <%== @pagy.series_nav(:bootstrap) %>
  </div>
</div>

<!-- ADD INVENTORY MODAL -->
<div id="addInventoryModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2>Add New Inventory</h2>
    <hr/>
    <%= render "form", inventory: Inventory.new, form_id: "newInventoryForm" %>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="viewInventoryModal" class="modal">
  <div class="modal-content">
    <span class="close-view-modal">&times;</span>
    <h2>View Inventory Details</h2>
    <hr/>
    <div id="viewInventoryDetails"></div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editInventoryModal" class="modal">
  <div class="modal-content">
    <span class="close-update-modal">&times;</span>
    <h2>Update Inventory</h2>
    <hr/>
    <%= render "form", inventory: @inventory_for_edit || Inventory.new, form_id: "editInventoryForm" %>
  </div>
</div>

<!-- DELETE MODAL -->
<div id="deleteInventoryModal" class="modal">
  <div class="modal-content">
    <span class="close-delete-modal">&times;</span>
    <h2>Delete Inventory</h2>
    <hr/>
    <p id="deleteConfirmMessage"></p>

    <%= form_with url: "", method: :delete, local: true, id: "deleteInventoryForm" do %>
      <div class="text-right">
        <%= button_tag "Delete", class: "btn btn-danger" %>
        <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
      </div>
    <% end %>
  </div>
</div>
</div>

<script>
document.addEventListener('turbo:load', () => {

  function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
  }

  // Populate category and unit selects
  const categoryOptions = <%= raw Category.order(:name).to_json(only: [:id, :name]) %>;
  const unitOptions = <%= raw Unit.order(:name).to_json(only: [:id, :name]) %>;

  const categorySelect = document.getElementById('inventory_category_id');
  const unitSelect = document.getElementById('inventory_unit_id');

  categoryOptions.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat.id;
    option.textContent = cat.name;
    categorySelect.appendChild(option);
  });

  unitOptions.forEach(unit => {
    const option = document.createElement('option');
    option.value = unit.id;
    option.textContent = unit.name;
    unitSelect.appendChild(option);
  });

  const addModal = document.getElementById('addInventoryModal');
  document.getElementById('openModalBtn').addEventListener('click', () => {
    closeAllModals();
    addModal.style.display = 'flex';
  });

  document.addEventListener('click', e => {

    // VIEW
    if (e.target.classList.contains('info-icon')) {
      const icon = e.target;
      closeAllModals();
      const row = icon.closest('tr');
      const viewModal = document.getElementById('viewInventoryModal');
      const detailsDiv = document.getElementById('viewInventoryDetails');
      detailsDiv.innerHTML = `
        <p><strong>ID:</strong> ${row.cells[0].textContent}</p>
        <p><strong>Name:</strong> ${row.cells[1].textContent}</p>
        <p><strong>Category:</strong> ${row.cells[2].textContent}</p>
        <p><strong>Unit:</strong> ${row.cells[3].textContent}</p>
        <p><strong>Quantity:</strong> ${row.cells[4].textContent}</p>
        <p><strong>Date:</strong> ${row.cells[5].textContent}</p>
        <p><strong>Price:</strong> ${row.cells[6].textContent}</p>
      `;
      viewModal.style.display = 'flex';
    }

// EDIT
if (e.target.classList.contains('edit-icon')) {
  const icon = e.target;
  closeAllModals();
  const inventoryId = icon.dataset.id;
  const editModal = document.getElementById('editInventoryModal');
  const form = editModal.querySelector('form');
  const row = icon.closest('tr');

  form.querySelector('#inventory_name').value = row.cells[1].textContent.trim();
  form.querySelector('#inventory_category_id').value = row.cells[2].dataset.id || '';
  form.querySelector('#inventory_unit_id').value = row.cells[3].dataset.id || '';
  form.querySelector('#inventory_stock_quantity').value = row.cells[4].textContent.trim();

  const inputDate = row.cells[5].textContent.trim();  // dd-mm-yyyy
  if (inputDate.includes('-')) {
    const [day, month, year] = inputDate.split('-');
    form.querySelector('#inventory_input_date').value = `${year}-${month}-${day}`;
  }
  let price = row.cells[6].textContent
  .replace('RM', '')    
  .replace(/,/g, '')    
  .trim();

  form.querySelector('#inventory_price').value = price;
  form.querySelector('#inventory_supplier').value = row.dataset.supplier || '';
  form.querySelector('#inventory_currency').value = 'RM'; // Default currency

  // Set form action for PATCH request (update)
  form.action = `/inventories/${inventoryId}`;
  form.method = 'POST';
  
  // Add hidden _method field for Rails to recognize as PATCH
  let methodInput = form.querySelector('input[name="_method"]');
  if (!methodInput) {
    methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);
  }
  
  editModal.style.display = 'flex';
}


    // DELETE
    if (e.target.classList.contains('delete-icon')) {
      const icon = e.target;
      closeAllModals();
      const inventoryId = icon.dataset.id;
      const deleteModal = document.getElementById('deleteInventoryModal');
      const deleteForm = document.getElementById('deleteInventoryForm');

      deleteForm.action = `/inventories/${inventoryId}`;
      document.getElementById('deleteConfirmMessage').textContent = `Are you sure you want to delete inventory #${inventoryId}?`;
      deleteModal.style.display = 'flex';
    }

    // CLOSE MODALS
    if (e.target.matches('.close-modal, .close-view-modal, .close-update-modal, .close-delete-modal, #cancelDeleteBtn, #cancelEditBtn')) {
      const modal = e.target.closest('.modal');
      if (modal) modal.style.display = 'none';
    }
  });

  // Close modals on clicking outside modal content
  window.addEventListener('click', e => {
    if (e.target.classList.contains('modal')) e.target.style.display = 'none';
  });

});
</script>
