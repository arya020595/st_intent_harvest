<%# Fallback to instance variables if locals are not provided %>
<% worker_data          = local_assigns[:worker] || @worker %>
<% payslip_detail_data   = local_assigns[:payslip_detail] || @payslip_detail %>
<% work_orders          = local_assigns[:work_order_workers] || [] %>
<% month_year_data      = local_assigns[:month_year_date] || @month_year_date %>

<table style="width: 100%; margin-bottom: 20px; border: none; border-collapse: collapse;">
  <tr>
    <!-- Left: Address -->
    <td style="text-align: left; vertical-align: top; line-height: 1.2; border: none;">
      <p><strong>Intent Harvest Sdn. Bhd. (977470-K)</strong></p>
      <p><strong>3rd floor, Lot 16, Block K, Jalan Ikan</strong></p>
      <p><strong>Juara Satu, Sadong Jaya,</strong></p>
      <p><strong>Karamunsing, 88000, Kota Kinabalu, Sabah</strong></p>
    </td>
    <!-- Right: Logo -->
    <td style="text-align: right; vertical-align: top; width: 200px; border: none;">
      <%= inline_image_base64('intent-harvest-logo.png', alt: 'Intent Harvest', style: 'width: 125px; height: auto;') %>
    </td>
  </tr>
</table>

<hr/>
<h1>EMPLOYEE PAYSLIP</h1>
<h3>
  <% if month_year_data %>
    ( <%= month_year_data.strftime('%B %Y') %> )
  <% else %>
    Unknown Month
  <% end %>
</h3>

<!-- Worker Info -->
<table style="width: 100%; margin-bottom: 20px;">
  <tr>
    <td><strong>Worker Name:</strong> <%= worker_data&.name || "N/A" %></td>
    <td><strong>Gender:</strong> <%= worker_data&.gender || "N/A" %></td>
  </tr>
  <tr>
    <td><strong>Worker ID:</strong> <%= worker_data&.id || "N/A" %></td>
    <td><strong>Nationality:</strong> <%= worker_data&.nationality || "N/A" %></td>
  </tr>
  <tr>
    <td><strong>Hired Date:</strong> <%= worker_data&.hired_date ? worker_data.hired_date.strftime('%d-%m-%Y') : "N/A" %></td>
    <td><strong>Worker Type:</strong> <%= worker_data&.worker_type || "N/A" %></td>
  </tr>
</table>

<!-- Earnings Table -->
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
  <thead style="background-color: #f0f0f0;">
    <tr>
      <th>Earnings</th>
      <th>Quantity</th>
      <th>Rate (RM)</th>
      <th>Total (RM)</th>
    </tr>
  </thead>
  <tbody>
    <% if work_orders.any? %>
      <% work_orders.each do |order_worker| %>
        <% order = order_worker.work_order %>
        <% unit_name = order.work_order_rate&.unit&.name || "N/A" %>
        <% quantity  = order_worker.work_area_size || 0 %>
        <tr>
          <td><%= order.work_order_rate_name || "N/A" %></td>
          <td><%= "#{quantity} #{unit_name}" %></td>
          <td class="text-center" style="text-align: center;">
            <%= number_to_currency(order.work_order_rate_price || 0, unit: '', separator: '.', delimiter: ',', precision: 2) %>
          </td>
          <td class="text-center" style="text-align: center;">
            <%= number_to_currency(order_worker.amount || 0, unit: '', separator: '.', delimiter: ',', precision: 2) %>
          </td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="4" style="text-align:center;">No work orders for this period.</td>
      </tr>
    <% end %>
  </tbody>
  <tfoot>
    <tr class="totals">
      <td class="text-center" colspan="3">Overall Total (RM):</td>
      <td class="text-center" style="text-align: center;">
        <%= number_to_currency(payslip_detail_data&.gross_salary || 0, unit: '', separator: '.', delimiter: ',', precision: 2) %>
      </td>
    </tr>
  </tfoot>
</table>

<hr/>

<%
  deduction_breakdown = payslip_detail_data&.deduction_breakdown || {}
  total_employee_deduction = payslip_detail_data&.employee_deductions || 0
  overall_net_pay = (payslip_detail_data&.gross_salary || 0) - total_employee_deduction
%>

<!-- Deduction Table -->
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
  <thead style="background-color: #f0f0f0;">
    <tr>
      <th>Deduction</th>
      <th>Employer (RM)</th>
      <th>Employee (RM)</th>
    </tr>
  </thead>
  <tbody>
    <% if deduction_breakdown.any? %>
      <% deduction_breakdown.each do |_, data| %>
        <tr>
          <td><%= data['name'] %></td>
          <td class="text-center" style="text-align: center;">
            <%= data['employer_amount'].to_f.zero? ? '-' : number_to_currency(data['employer_amount'], unit: '', separator: '.', delimiter: ',', precision: 2) %>
          </td>
          <td class="text-center" style="text-align: center;">
            <%= data['employee_amount'].to_f.zero? ? '-' : number_to_currency(data['employee_amount'], unit: '', separator: '.', delimiter: ',', precision: 2) %>
          </td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="3" style="text-align:center;">No deductions applicable.</td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="totals" style="margin-top: 15px;">
  <strong>Total Deduction (RM):</strong>
  <%= number_to_currency(total_employee_deduction, unit: '', separator: '.', delimiter: ',', precision: 2) %>
</div>

<div class="totals" style="margin-top: 15px;">
  <strong>Overall Net Pay (RM):</strong>
  <%= number_to_currency(overall_net_pay, unit: '', separator: '.', delimiter: ',', precision: 2) %>
</div>
