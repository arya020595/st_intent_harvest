<table style="width: 100%; margin-bottom: 20px; border: none; border-collapse: collapse;">
  <tr>
    <!-- Left: Address -->
    <td style="text-align: left; vertical-align: top; line-height: 1.2; border: none;">
      <p><strong>2nd floor, Lot 16, Block K, Jalan Ikan</strong></p>
      <p><strong>Juara Satu, Sadong Jaya,</strong></p>
      <p><strong>Karamunsing, 88000, Kota Kinabalu, Sabah</strong></p>
    </td>

    <!-- Right: Logo -->
    <td style="text-align: right; vertical-align: top; width: 200px; border: none;">
    <%= image_tag "data:image/webp;base64,#{Base64.encode64(File.read(Rails.root.join('app','assets','images','intent-harvest-logo.webp')))}",
          style: "width: 100%; height: auto;" %>

    </td>
  </tr>
</table>

<hr/>

<h1>EMPLOYEE PAYSLIP</h1>

<h3>
  <% if @month_year_date %>
    (<%= @month_year_date.strftime('%B %Y') %>)
  <% else %>
    Unknown Month
  <% end %>
</h3>


  <!-- Worker Info -->
  <table style="width: 100%; margin-bottom: 20px;">
    <tr>
      <td><strong>Worker Name:</strong> <%= @worker&.name || "N/A" %></td>
      <td><strong>Gender:</strong> <%= @worker&.gender || "N/A" %></td>
    </tr>
    <tr>
      <td><strong>Worker ID:</strong> <%= @worker&.id || "N/A" %></td>
      <td><strong>Nationality:</strong> <%= @worker&.nationality || "N/A" %></td>
    </tr>
    <tr>
      <td><strong>Hired Date:</strong> <%= @worker&.hired_date&.strftime('%d-%m-%Y') || "N/A" %></td>
      <td><strong>Worker Type:</strong> <%= @worker&.worker_type || "N/A" %></td>
    </tr>
  </table>

<%
  total_quantity = 0
  total_amount   = 0  # Gross salary
%>

<!-- Earnings Table -->
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
  <thead style="background-color: #f0f0f0;">
    <tr>
      <th>Earnings</th>
      <th>Quantity</th>
      <th>Rate (RM)</th>
      <th>Total (RM)</th>
    </tr>
  </thead>

  <tbody>
    <% if @work_orders.any? %>
      <% @work_orders.each do |order| %>

        <% order_worker = order.work_order_workers.find_by(worker_id: @worker.id) %>
        <% next unless order_worker %>

        <% unit_name = order.work_order_rate&.unit&.name || "N/A" %>
        <% quantity  = order_worker.work_area_size || 0 %>

        <% total_quantity += quantity.to_f %>
        <% total_amount += order_worker.amount.to_f %>

        <tr>
          <td><%= order.work_order_rate_name || "N/A" %></td>
          <td><%= "#{quantity} #{unit_name}" %></td>
          <td><%= sprintf('%.2f', order.work_order_rate_price) %></td>
          <td><%= number_to_currency(order_worker.amount, unit: 'RM ', separator: '.', delimiter: ',', precision: 2) %></td>
        </tr>

      <% end %>
    <% else %>
      <tr>
        <td colspan="4" style="text-align:center;">No work orders for this period.</td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="totals" style="margin-top: 15px;">
  <strong>Total Amount (RM):</strong> <%= sprintf('%.2f', total_amount) %>
</div>

<hr/>

<%
  # Hardcoded deduction rules
  deductions = [
    { name: "EPF",  nationality: "all",       employer: 12.0, employee: 11.0 },
    { name: "SOCSO", nationality: "local",    employer: 1.75, employee: 0.5 },
    { name: "SOCSO", nationality: "foreigner", employer: 1.25, employee: 0.0 },
    { name: "SIP",   nationality: "local",     employer: 0.2,  employee: 0.2 }
  ]

  worker_nat = @worker&.nationality&.downcase || "local"

  # Select deduction entries matching nationality or "all"
  applicable_deductions = deductions.select do |d|
    d[:nationality] == "all" || d[:nationality] == worker_nat
  end

  # Calculate percentage-based deduction amounts
  applicable_deductions.each do |d|
    d[:employer_rm] = total_amount * (d[:employer] / 100.0)
    d[:employee_rm] = total_amount * (d[:employee] / 100.0)
  end

  # Total employee deduction affects net salary
  total_employee_deduction = applicable_deductions.sum { |d| d[:employee_rm] }

  # Net salary after employee deduction
  overall_net_pay = total_amount - total_employee_deduction
%>

<!-- Deduction Table (RM Display) -->
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
  <thead style="background-color: #f0f0f0;">
    <tr>
      <th>Deduction</th>
      <th>Employer (RM)</th>
      <th>Employee (RM)</th>
    </tr>
  </thead>
  <tbody>
    <% applicable_deductions.each do |d| %>
      <tr>
        <td><%= d[:name] %></td>
        <td><%= number_to_currency(d[:employer_rm], unit: 'RM ', separator: '.', delimiter: ',', precision: 2) %></td>
        <td><%= number_to_currency(d[:employee_rm], unit: 'RM ', separator: '.', delimiter: ',', precision: 2) %></td>
      </tr>
    <% end %>
  </tbody>
</table>


<div class="totals" style="margin-top: 15px;">
  <strong>Total Deduction (RM):</strong> <%= sprintf('%.2f', total_employee_deduction) %>
</div>

<div class="totals" style="margin-top: 15px;">
  <strong>Overall Net Pay (RM):</strong> <%= sprintf('%.2f', overall_net_pay) %>
</div>
