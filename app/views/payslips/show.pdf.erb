<%
  # Use absolute path for images in PDF to ensure Grover can load them
  logo_path = Rails.root.join('app', 'assets', 'images', ENV['APP_LOGO_PNG_URL'])
  logo_base64 = Base64.strict_encode64(File.read(logo_path))
  logo_data_url = "data:image/png;base64,#{logo_base64}"

  # Deduction breakdown
  deduction_breakdown = payslip_detail.deduction_breakdown || {}
  total_employee_deduction = payslip_detail.employee_deductions || 0
  overall_net_pay = payslip_detail.gross_salary - total_employee_deduction
%>
<!-- Header -->
<table style="width: 100%; margin-bottom: 20px; border: none; border-collapse: collapse;">
  <tr>
    <!-- Left: Address -->
    <td style="text-align: left; vertical-align: top; line-height: 1.2; border: none;">
      <p><strong><%= ENV['APP_COMPANY_FULL_NAME'] %> (977470-K)</strong></p>
      <p><strong>3rd floor, Lot 16, Block K, Jalan Ikan</strong></p>
      <p><strong>Juara Satu, Sadong Jaya,</strong></p>
      <p><strong>Karamunsing, 88000, Kota Kinabalu, Sabah</strong></p>
    </td>
    <!-- Right: Logo -->
    <td style="text-align: right; vertical-align: top; width: 200px; border: none;">
      <img src="<%= logo_data_url %>" style="width: 100%; height: auto;" />
    </td>
  </tr>
</table>
<hr/>
<h1>EMPLOYEE PAYSLIP</h1>
<h3>
  <% if month_year_date %>
    (<%= month_year_date.strftime('%B %Y') %>)
  <% else %>
    Unknown Month
  <% end %>
</h3>
<!-- Worker Info -->
<table style="width: 100%; margin-bottom: 20px;">
  <tr>
    <td><strong>Worker Name:</strong> <%= worker&.name || "N/A" %></td>
    <td><strong>Gender:</strong> <%= worker&.gender || "N/A" %></td>
  </tr>
  <tr>
    <td><strong>Worker ID:</strong> <%= worker&.id || "N/A" %></td>
    <td><strong>Nationality:</strong> <%= worker&.nationality&.humanize&.capitalize || "N/A" %></td>
  </tr>
  <tr>
    <td><strong>Hired Date:</strong> <%= worker&.hired_date ? worker.hired_date.strftime('%d-%m-%Y') : "N/A" %></td>
    <td><strong>Worker Type:</strong> <%= worker&.worker_type || "N/A" %></td>
  </tr>
  <tr>
    <td><strong>Position:</strong> <%= worker&.position || "N/A" %></td>
    <td></td>
  </tr>
</table>
<!-- Earnings Table -->
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
  <thead style="background-color: #f0f0f0;">
    <tr>
      <th>Earnings</th>
      <th>Quantity</th>
      <th>Rate (RM)</th>
      <th>Total (RM)</th>
    </tr>
  </thead>
  <tbody>
    <% if work_order_workers.any? %>
      <% work_order_workers.each do |order_worker| %>
        <% order = order_worker.work_order %>
        <% unit_name = order.work_order_rate_unit_name || "N/A" %>
        <% quantity  = order_worker.work_area_size || 0 %>
        <tr>
          <td><%= order.work_order_rate_name || "N/A" %></td>
          <td><%= "#{quantity} #{unit_name}" %></td>
          <td class="text-center"><%= number_to_currency(order.work_order_rate_price, unit: '', separator: '.', delimiter: ',', precision: 2) %></td>
          <td class="text-center"><%= number_to_currency(order_worker.amount, unit: '', separator: '.', delimiter: ',', precision: 2) %></td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="4" style="text-align:center;">No work orders for this period.</td>
      </tr>
    <% end %>
  </tbody>
  <tfoot>
    <tr class="totals">
      <td colspan="3" class="text-center">Overall Total (RM):</td>
      <td class="text-center"><%= number_to_currency(payslip_detail.gross_salary, unit: '', separator: '.', delimiter: ',', precision: 2) %></td>
    </tr>
  </tfoot>
</table>
<hr/>
<!-- Deductions Table -->
<table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
  <thead style="background-color: #f0f0f0;">
    <tr>
      <th>Deduction</th>
      <th>Employer (RM)</th>
      <th>Employee (RM)</th>
    </tr>
  </thead>
  <tbody>
    <% if deduction_breakdown.any? %>
      <% sorted_deductions(deduction_breakdown).each do |deduction_code, data| %>
        <tr>
          <td><%= data['name'] %></td>
          <td class="text-center"><%= data['employer_amount'] == 0 ? '-' : number_to_currency(data['employer_amount'], unit: '', separator: '.', delimiter: ',', precision: 2) %></td>
          <td class="text-center"><%= data['employee_amount'] == 0 ? '-' : number_to_currency(data['employee_amount'], unit: '', separator: '.', delimiter: ',', precision: 2) %></td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="3" style="text-align:center;">No deductions applicable.</td>
      </tr>
    <% end %>
  </tbody>
</table>
<div class="totals" style="margin-top: 15px;">
  <strong>Total Deduction (RM):</strong>
  <%= number_to_currency(total_employee_deduction, unit: '', separator: '.', delimiter: ',', precision: 2) %>
</div>
<div class="totals" style="margin-top: 15px;">
  <strong>Overall Net Pay (RM):</strong>
  <%= number_to_currency(overall_net_pay, unit: '', separator: '.', delimiter: ',', precision: 2) %>
</div>
