<div class="payslip-page">
  <h1>Payslip</h1>
  <div class="row">
    <!-- LEFT SIDE: FILTERS -->
    <div class="col-md-3">
      <div class="card p-3">
        <h4>Payslip Filter</h4>
        <hr/>
        <%= form_with url: payslips_path, method: :get, local: true do |f| %>

          <!-- MONTH -->
          <div class="form-group mt-2">
            <%= f.label :month, "Month" %>
            <% available_months = PayCalculation.distinct.pluck(:month_year).map { |d| Date.parse(d + '-01').month }.uniq.sort %>
            <select name="month" id="month" class="form-control">
              <option value="" disabled <%= "selected" if params[:month].blank? %> class="text-muted">Select Month</option>
              <% available_months.each do |m| %>
                <option value="<%= m %>" <%= "selected" if params[:month].to_s == m.to_s %>>
                  <%= Date::MONTHNAMES[m] %>
                </option>
              <% end %>
            </select>
          </div>

          <!-- YEAR -->
          <div class="form-group mt-2">
            <%= f.label :year, "Year" %>
            <% available_years = PayCalculation.distinct.pluck(:month_year).map { |d| Date.parse(d + '-01').year }.uniq.sort %>
            <select name="year" id="year" class="form-control">
              <option value="" disabled <%= "selected" if params[:year].blank? %> class="text-muted">Select Year</option>
              <% available_years.each do |y| %>
                <option value="<%= y %>" <%= "selected" if params[:year].to_s == y.to_s %>><%= y %></option>
              <% end %>
            </select>
          </div>

          <!-- WORKER -->
          <div class="form-group mt-2 text-start">
            <%= f.label :worker_ids, "Workers", class: "form-label" %>
            <div class="dropdown w-100">
              <% selected_worker_ids = Array(params[:worker_ids]) %>
              <% selected_worker_names = if selected_worker_ids.include?("all")
                                          Worker.pluck(:name)
                                        else
                                          Worker.where(id: selected_worker_ids.map(&:to_i)).pluck(:name)
                                        end %>

              <button class="btn btn-outline-secondary dropdown-toggle text-truncate w-100"
                      type="button"
                      id="workerDropdown"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <% if selected_worker_names.any? %>
                  <% if selected_worker_names.size > 3 %>
                    <%= "#{selected_worker_names.size} Workers Selected" %>
                  <% else %>
                    <%= selected_worker_names.join(", ") %>
                  <% end %>
                <% else %>
                  Select Workers
                <% end %>
              </button>

              <ul class="dropdown-menu w-100 p-2" aria-labelledby="workerDropdown" style="max-height: 250px; overflow-y: auto;">

                <!-- SEARCH INPUT -->
                <li class="mb-2">
                  <input type="text" id="worker-search" class="form-control form-control-sm" placeholder="Search workers..." aria-label="Search workers">
                </li>
                <li><hr class="dropdown-divider"></li>

                <!-- Select All Option -->
                <li>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="worker_ids[]" value="all"
                          id="worker_all" <%= "checked" if selected_worker_ids.include?("all") %>>
                    <label class="form-check-label" for="worker_all"><strong>Select All Workers</strong></label>
                  </div>
                </li>
                <hr/>

                <!-- Individual Workers -->
                <% Worker.all.each do |w| %>
                  <li class="worker-item" data-worker-name="<%= w.name.downcase %>">
                    <div class="form-check">
                      <input
                        class="form-check-input worker-checkbox"
                        type="checkbox"
                        name="worker_ids[]"
                        value="<%= w.id %>"
                        data-worker-name="<%= w.name %>"
                        id="worker_<%= w.id %>"
                        <%= "checked" if selected_worker_ids.include?(w.id.to_s) || selected_worker_ids.include?("all") %>
                      >
                      <label class="form-check-label" for="worker_<%= w.id %>">
                        <%= w.name %>
                      </label>
                    </div>
                  </li>
                <% end %>

              </ul>
            </div>

            <!-- VIEW SELECTED WORKERS -->
            <div id="selected-workers" class="mt-2 d-flex flex-wrap gap-2"></div>
          </div>

          <!-- GENERATE BUTTON -->
          <%= button_tag(type: 'submit', class: 'btn btn-success w-100 mt-3', id: 'generate-btn', disabled: true) do %>
            <i class="bi bi-file-earmark-text-fill text-white"></i> Generate
          <% end %>

        <% end %>
      </div>
    </div>

    <!-- RIGHT SIDE: PDF VIEWER -->
    <div class="col-md-9">
      <div class="card p-3" style="text-align: center; min-height: 500px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <% if params[:worker_ids].present? && params[:month].present? && params[:year].present? %>
          <% month = params[:month].to_i %>
          <% year  = params[:year].to_i %>
          <% worker_ids = params[:worker_ids].map(&:to_i) %>
          <% workers = Worker.where(id: worker_ids) %>

          <% no_payslip = workers.all? do |worker|
               !PayslipServices::FetchPayslipDataService.new(worker: worker, month_year: format('%04d-%02d', year, month)).call.success?
             end %>

          <% if no_payslip %>
            <div class="text-center">
              <%= image_tag "clipboard-unavailable.png", alt: "No Payslip Available", class: "d-block mx-auto mb-3", width: "100px", height: "100px" %>
              <h5>No Payslip Available</h5>
              <p class="text-muted">Please ensure work orders have been completed and processed for this month.</p>
            </div>
          <% else %>
            <iframe src="<%= payslips_path(worker_ids: params[:worker_ids], month: params[:month], year: params[:year], format: :pdf) %>"
                    width="100%" height="500px" style="border: 1px solid #ccc;"></iframe>
          <% end %>
        <% else %>
          <div class="text-center">
            <%= image_tag "clipboard-icon.png", alt: "No Payslip Selected", class: "d-block mx-auto mb-3", width: "100px", height: "100px" %>
            <p class="text-muted">Select options from the filter fields on the left to generate a report.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript to handle search, select all, chips & removal -->
<script>
function initWorkerSelection() {
  const selectedContainer = document.getElementById('selected-workers');
  const selectAll = document.getElementById('worker_all');
  const workerCheckboxes = document.querySelectorAll('.worker-checkbox');
  const searchInput = document.getElementById('worker-search');
  const workerItems = document.querySelectorAll('.worker-item');

  if (!selectedContainer) return;

  function addWorker(id, name) {
    if (document.getElementById(`selected-worker-${id}`)) return;

    const chip = document.createElement('span');
    chip.className = 'worker-chip d-flex align-items-center';
    chip.id = `selected-worker-${id}`;
    chip.innerHTML = `
      ${name}
      <button type="button" class="remove-worker" data-worker-id="${id}" aria-label="Remove worker">
        <i class="bi bi-x-circle-fill"></i>
      </button>
    `;
    selectedContainer.appendChild(chip);
  }

  function updateGenerateButtonState() {
  const monthSelect = document.getElementById('month');
  const yearSelect = document.getElementById('year');
  const workerCheckboxes = document.querySelectorAll('.worker-checkbox');
  const generateBtn = document.getElementById('generate-btn');

  if (!monthSelect || !yearSelect || !generateBtn) return;

  // Check if month and year are selected
  const monthSelected = monthSelect.value !== '';
  const yearSelected = yearSelect.value !== '';

  // Check if at least one worker is checked
  const workerSelected = Array.from(workerCheckboxes).some(cb => cb.checked);

  generateBtn.disabled = !(monthSelected && yearSelected && workerSelected);
}

// Listen for changes on month, year, and worker checkboxes
// Initial check
updateGenerateButtonState();

const monthSelect = document.getElementById('month');
const yearSelect = document.getElementById('year');

if (monthSelect) monthSelect.addEventListener('change', updateGenerateButtonState);
if (yearSelect) yearSelect.addEventListener('change', updateGenerateButtonState);

workerCheckboxes.forEach(cb =>
  cb.addEventListener('change', updateGenerateButtonState)
);



  function removeWorker(id) {
    document.getElementById(`selected-worker-${id}`)?.remove();
    const checkbox = document.getElementById(`worker_${id}`);
    if (checkbox) checkbox.checked = false;
    if (selectAll && ![...workerCheckboxes].every(c => c.checked)) selectAll.checked = false;
  }

  function syncFromCheckboxes() {
    selectedContainer.innerHTML = '';
    workerCheckboxes.forEach(cb => {
      if (cb.checked) addWorker(cb.value, cb.dataset.workerName);
    });
  }

  // Checkbox change
  workerCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      cb.checked ? addWorker(cb.value, cb.dataset.workerName) : removeWorker(cb.value);
      if (!cb.checked) selectAll.checked = false;
      else if ([...workerCheckboxes].every(c => c.checked)) selectAll.checked = true;
    });
  });

  // Select All
  if (selectAll) {
    selectAll.addEventListener('change', () => {
      workerCheckboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        selectAll.checked ? addWorker(cb.value, cb.dataset.workerName) : removeWorker(cb.value);
      });
    });
  }

  // Remove chip button
  selectedContainer.addEventListener('click', (e) => {
    const removeButton = e.target.closest('.remove-worker');
    if (!removeButton) return;
    removeWorker(removeButton.dataset.workerId);
  });

  // Search filter
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim();
      workerItems.forEach(item => {
        const name = item.dataset.workerName;
        item.style.display = name.includes(query) ? '' : 'none';
      });
    });
  }

  // Initial sync
  syncFromCheckboxes();
}

document.addEventListener('turbo:load', initWorkerSelection);
</script>
