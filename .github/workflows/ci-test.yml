name: Run Tests & Code Quality Checks

on:
  pull_request:
    branches:
      - develop
      - main

# Cancel in-progress runs when new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.7"
          bundler-cache: true

      - name: Run Rubocop (fail only on error)
        id: rubocop
        run: bundle exec rubocop --fail-level error

      - name: Run Brakeman security scanner
        id: brakeman
        run: bundle exec brakeman -q --no-progress

      - name: Precompile assets
        id: assets
        run: bundle exec rails assets:precompile

      - name: Generate job summary
        if: always()
        run: |
          echo "## ðŸ“Š Code Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.rubocop.outcome }}" == "success" ]; then
            echo "âœ… Rubocop: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Rubocop: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.brakeman.outcome }}" == "success" ]; then
            echo "âœ… Brakeman: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Brakeman: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.assets.outcome }}" == "success" ]; then
            echo "âœ… Assets: Compiled successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Assets: Compilation failed" >> $GITHUB_STEP_SUMMARY
          fi

      # TODO: enable after adding tests
      # - name: Run Tests
      #   run: bundle exec rails test
