name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Set deployment start time
        run: |
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Notify Slack - Deployment Starting
        run: |
          set -e

          REPO="${{ github.repository }}"
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          FULL_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          SHORT_SHA=$(echo "$FULL_SHA" | cut -c1-7)
          ACTOR='${{ github.actor }}'
          RUN_URL='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          COMMIT_MSG=$(echo ${{ toJson(github.event.workflow_run.head_commit.message || 'Manual dispatch') }} | sed 's/\\n/\n/g')

          payload=$(jq -n \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg sha "$SHORT_SHA" \
            --arg actor "$ACTOR" \
            --arg msg "$COMMIT_MSG" \
            --arg runurl "$RUN_URL" \
            '{
              text: ":rocket: Production deployment started",
              blocks: [
                { type: "header", text: { type: "plain_text", text: "üöÄ Production Deployment Started" } },
                { type: "section", fields: [
                    { type: "mrkdwn", text: ("*Repository:*\n" + $repo) },
                    { type: "mrkdwn", text: ("*Branch:*\n" + $branch) },
                    { type: "mrkdwn", text: ("*Commit:*\n" + $sha) },
                    { type: "mrkdwn", text: ("*Actor:*\n" + $actor) }
                  ]
                },
                { type: "section", text: { type: "mrkdwn", text: ("*Message:*\n" + $msg) } },
                { type: "context", elements: [
                    { type: "mrkdwn", text: ("<" + $runurl + "|View workflow run>") }
                  ]
                }
              ]
            }')
          echo "$payload" | curl -s -X POST -H 'Content-type: application/json' -d @- "$SLACK_WEBHOOK_URL" || echo "Warning: Failed to send Slack notification"
          echo "Sent Slack start notification"

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          envs: DEPLOY_SHA
          script: |
            set -e

            # Configuration
            MAX_RETRIES=30
            RETRY_INTERVAL=5
            APPS=("st_intent_harvest" "st_accorn")
            DEPLOY_HISTORY_FILE=".deploy_history"
            MAX_HISTORY=10

            # Get short SHA for tagging
            SHORT_SHA=$(echo "$DEPLOY_SHA" | cut -c1-7)

            # Reusable deployment function (DRY principle)
            deploy_app() {
              local app_name=$1
              local app_path="/home/stadmin/${app_name}"

              echo ""
              echo "=========================================="
              echo "üì¶ Deploying ${app_name}..."
              echo "=========================================="

              cd "$app_path"

              # Save current image version before deploying (for rollback)
              echo "‚Üí Saving current deployment state..."
              CURRENT_IMAGE=$(docker compose images web --format "{{.Tag}}" 2>/dev/null | head -1 || echo "none")
              echo "  Current image tag: ${CURRENT_IMAGE}"

              echo "‚Üí Pulling Docker image with tag: main-${SHORT_SHA}..."
              docker pull ghcr.io/arya020595/${app_name}:main-${SHORT_SHA}

              echo "‚Üí Updating docker-compose to use specific image tag..."
              # Update DOCKER_IMAGE in .env file to use specific SHA tag
              if [ ! -f .env ]; then
                echo "‚ùå .env file not found in ${app_path}; cannot safely update DOCKER_IMAGE."
                echo "   Aborting deployment to avoid running an outdated image."
                return 1
              fi
              sed -i "s|^DOCKER_IMAGE=.*|DOCKER_IMAGE=ghcr.io/arya020595/${app_name}:main-${SHORT_SHA}|" .env || true
              # If DOCKER_IMAGE doesn't exist, add it
              grep -q "^DOCKER_IMAGE=" .env || echo "DOCKER_IMAGE=ghcr.io/arya020595/${app_name}:main-${SHORT_SHA}" >> .env

              echo "‚Üí Restarting services..."
              docker compose up -d

              echo "‚Üí Waiting for health check..."
              local retry_count=0
              while [ $retry_count -lt $MAX_RETRIES ]; do
                local container_id
                container_id=$(docker compose ps -q web || true)
                if [ -n "$container_id" ]; then
                  local health_status
                  health_status=$(docker inspect --format '{{.State.Health.Status}}' "$container_id" 2>/dev/null || echo "unknown")
                  if [ "$health_status" = "healthy" ]; then
                    echo "‚úì Service is healthy!"
                    break
                  fi
                fi

                retry_count=$((retry_count + 1))
                if [ $retry_count -eq $MAX_RETRIES ]; then
                  echo "‚ùå Health check failed after $((MAX_RETRIES * RETRY_INTERVAL))s"
                  docker compose ps
                  docker compose logs --tail=50 web
                  return 1
                fi

                echo "  Attempt ${retry_count}/${MAX_RETRIES}..."
                sleep $RETRY_INTERVAL
              done

              echo "‚Üí Running database migrations..."
              docker compose exec -T web rails db:migrate

              # Record deployment history AFTER successful deployment
              echo "‚Üí Recording deployment history..."
              echo "$(date -Iseconds)|main-${SHORT_SHA}|${CURRENT_IMAGE}" >> "$DEPLOY_HISTORY_FILE"
              # Keep only last N deployments
              tail -n $MAX_HISTORY "$DEPLOY_HISTORY_FILE" > "${DEPLOY_HISTORY_FILE}.tmp" && mv "${DEPLOY_HISTORY_FILE}.tmp" "$DEPLOY_HISTORY_FILE"

              echo "‚úÖ ${app_name} deployed successfully with tag: main-${SHORT_SHA}"
              docker compose ps
            }

            # Deploy all applications
            for app in "${APPS[@]}"; do
              deploy_app "$app" || exit 1
            done

            echo ""
            echo "=========================================="
            echo "‚úÖ All deployments completed successfully!"
            echo "   Deployed version: main-${SHORT_SHA}"
            echo "=========================================="

      - name: Notify Slack - Deployment Result
        if: always()
        run: |
          set -e
          REPO="${{ github.repository }}"
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          FULL_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          SHORT_SHA=$(echo "$FULL_SHA" | cut -c1-7)
          ACTOR='${{ github.actor }}'
          RUN_URL='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          STATUS='${{ job.status }}'
          END_TIME=$(date +%s)
          DURATION=$(( END_TIME - START_TIME ))
          HUMAN_DURATION=$(printf '%02dm:%02ds' $((DURATION/60)) $((DURATION%60)))
          COMMIT_MSG=$(echo ${{ toJson(github.event.workflow_run.head_commit.message || 'Manual dispatch') }} | sed 's/\\n/\n/g')

          if [ "$STATUS" = "success" ]; then
            TITLE="‚úÖ Production Deployment Succeeded"
            RESULT_LINE="*Result:* Success"
            COLOR="#2eb886"
            else
            TITLE="‚ùå Production Deployment Failed"
            RESULT_LINE="*Result:* Failure"
            COLOR="#e01e5a"
            fi

            payload=$(jq -n \
            --arg color "$COLOR" \
            --arg title "$TITLE" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg sha "$SHORT_SHA" \
            --arg actor "$ACTOR" \
            --arg msg "$COMMIT_MSG" \
            --arg runurl "$RUN_URL" \
            --arg result "$RESULT_LINE" \
            --arg dur "$HUMAN_DURATION" \
            '{
              text: $title,
              blocks: [
                { type: "header", text: { type: "plain_text", text: $title } },
                { type: "section", fields: [
                    { type: "mrkdwn", text: ("*Repository:*\n" + $repo) },
                    { type: "mrkdwn", text: ("*Branch:*\n" + $branch) },
                    { type: "mrkdwn", text: ("*Commit:*\n" + $sha) },
                    { type: "mrkdwn", text: ("*Actor:*\n" + $actor) },
                    { type: "mrkdwn", text: $result },
                    { type: "mrkdwn", text: ("*Duration:*\n" + $dur) }
                  ]
                },
                { type: "section", text: { type: "mrkdwn", text: ("*Message:*\n" + $msg) } },
                { type: "context", elements: [
                    { type: "mrkdwn", text: ("<" + $runurl + "|View workflow run>") }
                  ]
                }
              ]
            }')
          echo "$payload" | curl -s -X POST -H 'Content-type: application/json' -d @- "$SLACK_WEBHOOK_URL" || echo "Warning: Failed to send Slack notification"
          echo "Sent Slack result notification ($STATUS)"
